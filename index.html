<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown Workstation</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/11.1.1/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/tokyo-night-dark.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --lilac: #b19cd9;
            --lilac-bright: #c9b3ff;
            --lilac-dim: #9575cd;
            --purple: #8b5cf6;
            --terminal-green: #00ff41;
            --terminal-green-bright: #39ff14;
            --bg-light: #f5f3f7;
            --bg-lighter: #faf9fb;
            --glass-bg: rgba(245, 243, 247, 0.85);
            --text-dark: #2d1b3d;
            --editor-bg: #ffffff;
        }

        @keyframes scanline {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100vh); }
        }

        @keyframes glow-pulse {
            0%, 100% { filter: drop-shadow(0 0 3px var(--lilac)) drop-shadow(0 0 8px var(--lilac)); }
            50% { filter: drop-shadow(0 0 6px var(--lilac-bright)) drop-shadow(0 0 12px var(--lilac-bright)); }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        body {
            font-family: 'Courier New', monospace;
            background: var(--bg-lighter);
            color: var(--text-dark);
            min-height: 100vh;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--lilac), transparent);
            animation: scanline 8s linear infinite;
            opacity: 0.15;
            pointer-events: none;
            z-index: 1000;
        }

        .container {
            max-width: 100vw;
            margin: 0 auto;
            padding: 1rem;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            text-align: center;
            padding: 1.5rem 1rem;
            border-bottom: 2px solid var(--lilac);
            box-shadow: 0 2px 20px rgba(177, 156, 217, 0.3);
            margin-bottom: 1rem;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border-radius: 12px 12px 0 0;
        }

        h1 {
            font-size: clamp(1.2rem, 4vw, 2rem);
            text-transform: uppercase;
            letter-spacing: 0.3em;
            animation: glow-pulse 3s ease-in-out infinite;
            text-shadow: 0 0 10px var(--lilac), 0 0 20px var(--lilac);
            color: var(--lilac-dim);
        }

        .subtitle {
            color: var(--terminal-green);
            font-size: 0.8rem;
            margin-top: 0.3rem;
            letter-spacing: 0.2em;
            text-shadow: 0 0 5px var(--terminal-green);
        }

        .toolbar {
            display: flex;
            gap: 0.5rem;
            padding: 0.8rem;
            background: var(--glass-bg);
            border: 1px solid var(--lilac);
            border-radius: 8px;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            align-items: center;
            backdrop-filter: blur(10px);
        }

        .toolbar-btn {
            background: rgba(177, 156, 217, 0.2);
            border: 1px solid var(--lilac);
            color: var(--lilac-dim);
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            white-space: nowrap;
        }

        .toolbar-btn:hover {
            background: rgba(177, 156, 217, 0.4);
            box-shadow: 0 0 15px rgba(177, 156, 217, 0.4);
            transform: translateY(-2px);
        }

        .toolbar-btn.active {
            background: rgba(0, 255, 65, 0.2);
            border-color: var(--terminal-green);
            color: var(--terminal-green);
        }

        .toolbar-separator {
            width: 1px;
            height: 30px;
            background: var(--lilac);
            opacity: 0.3;
        }

        .filename-input {
            flex: 1;
            min-width: 200px;
            background: white;
            border: 1px solid var(--lilac-dim);
            color: var(--text-dark);
            padding: 0.5rem;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        .filename-input:focus {
            outline: none;
            border-color: var(--lilac);
            box-shadow: 0 0 10px rgba(177, 156, 217, 0.3);
        }

        .workspace {
            flex: 1;
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 1rem;
            overflow: hidden;
        }

        .sidebar {
            background: var(--glass-bg);
            border: 2px solid var(--terminal-green);
            border-radius: 8px;
            padding: 1rem;
            backdrop-filter: blur(10px);
            overflow-y: auto;
            box-shadow: 0 0 30px rgba(0, 255, 65, 0.2);
        }

        .sidebar-title {
            font-size: 1.1rem;
            margin-bottom: 1rem;
            color: var(--terminal-green);
            text-shadow: 0 0 8px var(--terminal-green);
            border-bottom: 1px solid var(--terminal-green);
            padding-bottom: 0.5rem;
        }

        .file-item {
            padding: 0.6rem;
            margin-bottom: 0.4rem;
            border: 1px solid var(--lilac-dim);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.5);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
        }

        .file-item:hover {
            border-color: var(--lilac);
            background: rgba(177, 156, 217, 0.2);
            transform: translateX(5px);
        }

        .file-item.active {
            border-color: var(--terminal-green);
            background: rgba(0, 255, 65, 0.15);
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.4);
        }

        .file-icon {
            font-size: 1rem;
        }

        .file-name {
            flex: 1;
            font-weight: bold;
            word-break: break-word;
        }

        .file-item.active .file-name {
            color: var(--terminal-green-bright);
        }

        .file-delete {
            background: rgba(255, 100, 100, 0.2);
            border: 1px solid #ff6464;
            color: #ff6464;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.7rem;
            transition: all 0.3s ease;
        }

        .file-delete:hover {
            background: rgba(255, 100, 100, 0.4);
            transform: scale(1.1);
        }

        .upload-area {
            border: 2px dashed var(--lilac);
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
            margin: 1rem 0;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(177, 156, 217, 0.05);
            font-size: 0.8rem;
        }

        .upload-area:hover {
            border-color: var(--purple);
            background: rgba(177, 156, 217, 0.1);
            box-shadow: 0 0 20px rgba(177, 156, 217, 0.2);
        }

        .upload-area.drag-over {
            border-color: var(--terminal-green);
            background: rgba(0, 255, 65, 0.1);
        }

        .upload-icon {
            font-size: 2rem;
            color: var(--lilac);
            margin-bottom: 0.5rem;
        }

        input[type="file"] {
            display: none;
        }

        .editor-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            overflow: hidden;
        }

        .editor-container.preview-only {
            grid-template-columns: 1fr;
        }

        .editor-container.editor-only {
            grid-template-columns: 1fr;
        }

        .editor-panel, .preview-panel {
            background: white;
            border: 2px solid var(--lilac);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 0 30px rgba(177, 156, 217, 0.2);
        }

        .panel-header {
            background: var(--lilac);
            color: white;
            padding: 0.6rem 1rem;
            font-weight: bold;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-tools {
            display: flex;
            gap: 0.5rem;
        }

        .panel-tool-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.3s ease;
        }

        .panel-tool-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .editor-textarea {
            flex: 1;
            padding: 1.5rem;
            border: none;
            font-family: 'Courier New', monospace;
            font-size: 0.95rem;
            line-height: 1.6;
            resize: none;
            color: var(--text-dark);
            background: var(--editor-bg);
        }

        .editor-textarea:focus {
            outline: none;
        }

        .preview-content {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            line-height: 1.8;
        }

        .preview-content h1,
        .preview-content h2,
        .preview-content h3,
        .preview-content h4,
        .preview-content h5,
        .preview-content h6 {
            color: var(--lilac-dim);
            margin: 2rem 0 1rem;
            text-shadow: 0 0 5px rgba(177, 156, 217, 0.3);
            border-bottom: 2px solid var(--lilac);
            padding-bottom: 0.5rem;
        }

        .preview-content h1 { font-size: 2rem; }
        .preview-content h2 { font-size: 1.6rem; }
        .preview-content h3 { font-size: 1.3rem; }

        .preview-content p {
            margin: 1rem 0;
        }

        .preview-content a {
            color: var(--purple);
            text-decoration: none;
            border-bottom: 1px solid var(--purple);
        }

        .preview-content code {
            background: rgba(177, 156, 217, 0.1);
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            color: var(--purple);
            font-size: 0.9em;
            border: 1px solid var(--lilac);
        }

        .preview-content pre {
            background: #1a1b26;
            border: 2px solid var(--terminal-green);
            border-radius: 8px;
            padding: 1.5rem;
            overflow-x: auto;
            margin: 1.5rem 0;
        }

        .preview-content pre code {
            background: none;
            border: none;
            padding: 0;
            color: var(--terminal-green);
        }

        .preview-content blockquote {
            border-left: 4px solid var(--lilac);
            padding-left: 1.5rem;
            margin: 1.5rem 0;
            color: var(--lilac-dim);
            font-style: italic;
            background: rgba(177, 156, 217, 0.05);
            padding: 1rem 1.5rem;
            border-radius: 0 8px 8px 0;
        }

        .preview-content ul, .preview-content ol {
            margin: 1rem 0 1rem 2rem;
        }

        .preview-content li {
            margin: 0.5rem 0;
        }

        .preview-content img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            border: 2px solid var(--lilac);
            margin: 1.5rem 0;
        }

        .preview-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5rem 0;
            border: 2px solid var(--lilac);
            border-radius: 8px;
            overflow: hidden;
        }

        .preview-content th {
            background: var(--lilac);
            color: white;
            padding: 0.8rem;
            text-align: left;
        }

        .preview-content td {
            padding: 0.6rem 0.8rem;
            border-bottom: 1px solid var(--lilac);
        }

        .preview-content tr:hover {
            background: rgba(177, 156, 217, 0.1);
        }

        .mermaid {
            background: rgba(177, 156, 217, 0.05);
            padding: 2rem;
            border-radius: 8px;
            border: 2px solid var(--lilac);
            margin: 1.5rem 0;
        }

        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--glass-bg);
            border: 2px solid var(--lilac);
            border-radius: 8px;
            padding: 1rem 1.5rem;
            color: var(--text-dark);
            backdrop-filter: blur(10px);
            box-shadow: 0 0 30px rgba(177, 156, 217, 0.3);
            z-index: 3000;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .toast.active {
            transform: translateY(0);
            opacity: 1;
        }

        .stats-bar {
            background: var(--glass-bg);
            border-top: 1px solid var(--lilac);
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
            color: var(--lilac-dim);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(177, 156, 217, 0.1);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--lilac);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--lilac-bright);
        }

        @media (max-width: 1200px) {
            .workspace {
                grid-template-columns: 200px 1fr;
            }
        }

        @media (max-width: 768px) {
            .workspace {
                grid-template-columns: 1fr;
            }

            .sidebar {
                max-height: 200px;
            }

            .editor-container {
                grid-template-columns: 1fr;
            }

            .toolbar {
                flex-direction: column;
            }

            .filename-input {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>‚óâ MD Workstation</h1>
            <div class="subtitle">[ edit.preview.export.markdown ]</div>
        </header>

        <div class="toolbar">
            <button class="toolbar-btn" onclick="newFile()" title="Nouveau fichier">
                üìÑ Nouveau
            </button>
            <button class="toolbar-btn" onclick="saveFile()" title="Sauvegarder">
                üíæ Sauvegarder
            </button>
            <button class="toolbar-btn" onclick="exportMd()" title="Exporter .md">
                üì• Export MD
            </button>
            <button class="toolbar-btn" onclick="exportHtml()" title="Exporter HTML">
                üåê Export HTML
            </button>
            
            <div class="toolbar-separator"></div>
            
            <button class="toolbar-btn active" id="viewSplit" onclick="setView('split')" title="Vue partag√©e">
                ‚öè Split
            </button>
            <button class="toolbar-btn" id="viewEditor" onclick="setView('editor')" title="√âditeur seul">
                ‚úèÔ∏è Edit
            </button>
            <button class="toolbar-btn" id="viewPreview" onclick="setView('preview')" title="Aper√ßu seul">
                üëÅÔ∏è Preview
            </button>
            
            <div class="toolbar-separator"></div>
            
            <input type="text" class="filename-input" id="filenameInput" placeholder="nom-du-fichier.md" value="document.md">
        </div>

        <div class="workspace">
            <div class="sidebar">
                <h3 class="sidebar-title">‚ü© Fichiers</h3>
                
                <label for="fileInput" class="upload-area" id="uploadArea">
                    <div class="upload-icon">‚¨Ü</div>
                    <div>Charger .md</div>
                </label>
                <input type="file" id="fileInput" accept=".md,.markdown" multiple>
                
                <div id="fileList"></div>
            </div>

            <div class="editor-container" id="editorContainer">
                <div class="editor-panel" id="editorPanel">
                    <div class="panel-header">
                        ‚úèÔ∏è √âditeur
                        <div class="panel-tools">
                            <button class="panel-tool-btn" onclick="insertText('# ')" title="Titre">H</button>
                            <button class="panel-tool-btn" onclick="insertText('**', '**')" title="Gras">B</button>
                            <button class="panel-tool-btn" onclick="insertText('*', '*')" title="Italique">I</button>
                            <button class="panel-tool-btn" onclick="insertText('`', '`')" title="Code">{ }</button>
                            <button class="panel-tool-btn" onclick="insertText('[', '](url)')" title="Lien">üîó</button>
                            <button class="panel-tool-btn" onclick="insertText('- ')" title="Liste">‚Ä¢</button>
                        </div>
                    </div>
                    <textarea class="editor-textarea" id="editor" placeholder="Commencez √† √©crire votre Markdown ici..."></textarea>
                    <div class="stats-bar">
                        <div class="stat-item">üìù <span id="charCount">0</span> caract√®res</div>
                        <div class="stat-item">üìä <span id="wordCount">0</span> mots</div>
                        <div class="stat-item">üìÑ <span id="lineCount">0</span> lignes</div>
                    </div>
                </div>

                <div class="preview-panel" id="previewPanel">
                    <div class="panel-header">
                        üëÅÔ∏è Aper√ßu en temps r√©el
                    </div>
                    <div class="preview-content" id="preview"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        let files = [];
        let currentFileIndex = -1;
        let currentView = 'split';

        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            themeVariables: {
                primaryColor: '#b19cd9',
                primaryTextColor: '#2d1b3d',
                primaryBorderColor: '#b19cd9',
                lineColor: '#8b5cf6',
                secondaryColor: '#c9b3ff',
                tertiaryColor: '#f5f3f7'
            }
        });

        marked.setOptions({
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    try {
                        return hljs.highlight(code, { language: lang }).value;
                    } catch (err) {}
                }
                return hljs.highlightAuto(code).value;
            },
            breaks: true,
            gfm: true,
            mangle: false,
            headerIds: true
        });

        const editor = document.getElementById('editor');
        const preview = document.getElementById('preview');
        const fileInput = document.getElementById('fileInput');
        const uploadArea = document.getElementById('uploadArea');
        const fileList = document.getElementById('fileList');
        const filenameInput = document.getElementById('filenameInput');
        const editorContainer = document.getElementById('editorContainer');

        // Live preview
        editor.addEventListener('input', () => {
            updatePreview();
            updateStats();
            if (currentFileIndex !== -1) {
                files[currentFileIndex].content = editor.value;
                files[currentFileIndex].modified = true;
                updateFileList();
            }
        });

        function updatePreview() {
            let html = marked.parse(editor.value);
            html = html.replace(/<pre><code class="language-mermaid">([\s\S]*?)<\/code><\/pre>/g, 
                '<div class="mermaid">$1</div>');
            preview.innerHTML = html;
            
            mermaid.run({
                querySelector: '.mermaid'
            });
        }

        function updateStats() {
            const text = editor.value;
            document.getElementById('charCount').textContent = text.length;
            document.getElementById('wordCount').textContent = text.trim() ? text.trim().split(/\s+/).length : 0;
            document.getElementById('lineCount').textContent = text.split('\n').length;
        }

        // Drag & Drop
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, (e) => {
                e.preventDefault();
                e.stopPropagation();
            });
        });

        ['dragenter', 'dragover'].forEach(eventName => {
            uploadArea.addEventListener(eventName, () => {
                uploadArea.classList.add('drag-over');
            });
        });

        ['dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, () => {
                uploadArea.classList.remove('drag-over');
            });
        });

        uploadArea.addEventListener('drop', (e) => {
            const droppedFiles = Array.from(e.dataTransfer.files);
            handleFiles(droppedFiles);
        });

        fileInput.addEventListener('change', (e) => {
            const selectedFiles = Array.from(e.target.files);
            handleFiles(selectedFiles);
            fileInput.value = '';
        });

        function handleFiles(fileArray) {
            fileArray.forEach(file => {
                if (file.name.endsWith('.md') || file.name.endsWith('.markdown')) {
                    loadFile(file);
                } else {
                    showToast(`‚ùå "${file.name}" n'est pas un fichier Markdown`);
                }
            });
        }

        function loadFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const fileData = {
                    name: file.name,
                    content: e.target.result,
                    modified: false,
                    date: new Date()
                };
                
                const existingIndex = files.findIndex(f => f.name === file.name);
                if (existingIndex !== -1) {
                    files[existingIndex] = fileData;
                    showToast(`üìù "${file.name}" recharg√©`);
                } else {
                    files.push(fileData);
                    showToast(`‚úÖ "${file.name}" charg√©`);
                }
                
                updateFileList();
                openFile(existingIndex !== -1 ? existingIndex : files.length - 1);
            };
            reader.readAsText(file);
        }

        function updateFileList() {
            if (files.length === 0) {
                fileList.innerHTML = '<div style="padding: 1rem; text-align: center; color: var(--lilac-dim); font-size: 0.8rem;">Aucun fichier</div>';
                return;
            }

            fileList.innerHTML = files.map((file, index) => `
                <div class="file-item ${index === currentFileIndex ? 'active' : ''}" onclick="openFile(${index})">
                    <span class="file-icon">${file.modified ? '‚óè' : 'üìÑ'}</span>
                    <div class="file-name">${file.name}</div>
                    <button class="file-delete" onclick="deleteFile(event, ${index})" title="Supprimer">üóëÔ∏è</button>
                </div>
            `).join('');
        }

        function openFile(index) {
            currentFileIndex = index;
            const file = files[index];
            editor.value = file.content;
            filenameInput.value = file.name;
            updatePreview();
            updateStats();
            updateFileList();
        }

        function deleteFile(event, index) {
            event.stopPropagation();
            const fileName = files[index].name;
            files.splice(index, 1);
            
            if (currentFileIndex === index) {
                if (files.length > 0) {
                    openFile(Math.min(index, files.length - 1));
                } else {
                    currentFileIndex = -1;
                    editor.value = '';
                    filenameInput.value = 'document.md';
                    updatePreview();
                    updateStats();
                }
            } else if (currentFileIndex > index) {
                currentFileIndex--;
            }
            
            updateFileList();
            showToast(`üóëÔ∏è "${fileName}" supprim√©`);
        }

        function newFile() {
            const fileName = `nouveau-${files.length + 1}.md`;
            files.push({
                name: fileName,
                content: '',
                modified: false,
                date: new Date()
            });
            updateFileList();
            openFile(files.length - 1);
            showToast('üìÑ Nouveau fichier cr√©√©');
        }

        function saveFile() {
            if (currentFileIndex === -1 && editor.value.trim() === '') {
                showToast('‚ùå Aucun contenu √† sauvegarder');
                return;
            }

            const content = editor.value;
            const filename = filenameInput.value || 'document.md';
            
            if (currentFileIndex === -1) {
                files.push({
                    name: filename,
                    content: content,
                    modified: false,
                    date: new Date()
                });
                currentFileIndex = files.length - 1;
            } else {
                files[currentFileIndex].content = content;
                files[currentFileIndex].name = filename;
                files[currentFileIndex].modified = false;
            }
            
            updateFileList();
            showToast('üíæ Fichier sauvegard√© en m√©moire');
        }

        function exportMd() {
            const content = editor.value;
            const filename = filenameInput.value || 'document.md';
            
            if (!content.trim()) {
                showToast('‚ùå Aucun contenu √† exporter');
                return;
            }
            
            const blob = new Blob([content], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast(`üì• "${filename}" export√©`);
        }

        function exportHtml() {
            const content = editor.value;
            const filename = filenameInput.value.replace('.md', '.html') || 'document.html';
            
            if (!content.trim()) {
                showToast('‚ùå Aucun contenu √† exporter');
                return;
            }
            
            const html = `<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${filename.replace('.html', '')}</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            max-width: 800px; 
            margin: 2rem auto; 
            padding: 0 2rem; 
            line-height: 1.6;
            color: #2d1b3d;
        }
        h1, h2, h3, h4, h5, h6 {
            color: #9575cd;
            margin-top: 2rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #b19cd9;
            padding-bottom: 0.5rem;
        }
        code { 
            background: #f4f4f4; 
            padding: 0.2rem 0.4rem; 
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            color: #8b5cf6;
            border: 1px solid #b19cd9;
        }
        pre { 
            background: #1a1b26; 
            color: #00ff41;
            padding: 1rem; 
            border-radius: 8px; 
            overflow-x: auto;
            border: 2px solid #00ff41;
        }
        pre code {
            background: none;
            border: none;
            color: #00ff41;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 1.5rem 0;
            border: 2px solid #b19cd9;
            border-radius: 8px;
            overflow: hidden;
        }
        th {
            background: #b19cd9;
            color: white;
            padding: 0.8rem;
            text-align: left;
        }
        td {
            border-bottom: 1px solid #b19cd9;
            padding: 0.6rem 0.8rem;
        }
        tr:hover {
            background: rgba(177, 156, 217, 0.1);
        }
        img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            border: 2px solid #b19cd9;
            margin: 1.5rem 0;
        }
        blockquote {
            border-left: 4px solid #b19cd9;
            padding-left: 1.5rem;
            margin: 1.5rem 0;
            color: #9575cd;
            font-style: italic;
            background: rgba(177, 156, 217, 0.05);
            padding: 1rem 1.5rem;
            border-radius: 0 8px 8px 0;
        }
        a {
            color: #8b5cf6;
            text-decoration: none;
            border-bottom: 1px solid #8b5cf6;
        }
        a:hover {
            color: #c9b3ff;
            border-bottom-color: #c9b3ff;
        }
        ul, ol {
            margin: 1rem 0 1rem 2rem;
        }
        li {
            margin: 0.5rem 0;
        }
    </style>
</head>
<body>
${preview.innerHTML}
</body>
</html>`;
            
            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast(`üåê "${filename}" export√©`);
        }

        function setView(view) {
            currentView = view;
            
            document.getElementById('viewSplit').classList.remove('active');
            document.getElementById('viewEditor').classList.remove('active');
            document.getElementById('viewPreview').classList.remove('active');
            
            editorContainer.classList.remove('editor-only', 'preview-only');
            
            if (view === 'split') {
                document.getElementById('viewSplit').classList.add('active');
            } else if (view === 'editor') {
                document.getElementById('viewEditor').classList.add('active');
                editorContainer.classList.add('editor-only');
                document.getElementById('previewPanel').style.display = 'none';
            } else if (view === 'preview') {
                document.getElementById('viewPreview').classList.add('active');
                editorContainer.classList.add('preview-only');
                document.getElementById('editorPanel').style.display = 'none';
            }
            
            if (view !== 'preview') {
                document.getElementById('editorPanel').style.display = 'flex';
            }
            if (view !== 'editor') {
                document.getElementById('previewPanel').style.display = 'flex';
            }
        }

        function insertText(before, after = '') {
            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            const text = editor.value;
            const selectedText = text.substring(start, end);
            
            const newText = text.substring(0, start) + before + selectedText + after + text.substring(end);
            editor.value = newText;
            
            const newCursorPos = start + before.length + selectedText.length;
            editor.setSelectionRange(newCursorPos, newCursorPos);
            editor.focus();
            
            updatePreview();
            updateStats();
            
            if (currentFileIndex !== -1) {
                files[currentFileIndex].content = editor.value;
                files[currentFileIndex].modified = true;
                updateFileList();
            }
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('active');
            
            setTimeout(() => {
                toast.classList.remove('active');
            }, 3000);
        }

        // Raccourcis clavier
        document.addEventListener('keydown', (e) => {
            // Ctrl+S / Cmd+S pour sauvegarder
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                saveFile();
            }
            
            // Ctrl+N / Cmd+N pour nouveau fichier
            if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                e.preventDefault();
                newFile();
            }
            
            // Ctrl+E / Cmd+E pour exporter MD
            if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                e.preventDefault();
                exportMd();
            }
            
            // Ctrl+1/2/3 pour changer de vue
            if ((e.ctrlKey || e.metaKey) && e.key === '1') {
                e.preventDefault();
                setView('split');
            }
            if ((e.ctrlKey || e.metaKey) && e.key === '2') {
                e.preventDefault();
                setView('editor');
            }
            if ((e.ctrlKey || e.metaKey) && e.key === '3') {
                e.preventDefault();
                setView('preview');
            }
            
            // Ctrl+B pour gras
            if ((e.ctrlKey || e.metaKey) && e.key === 'b') {
                e.preventDefault();
                insertText('**', '**');
            }
            
            // Ctrl+I pour italique
            if ((e.ctrlKey || e.metaKey) && e.key === 'i') {
                e.preventDefault();
                insertText('*', '*');
            }
            
            // Ctrl+K pour lien
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                insertText('[', '](url)');
            }
        });

        // Auto-save toutes les 30 secondes
        setInterval(() => {
            if (currentFileIndex !== -1 && files[currentFileIndex].modified) {
                files[currentFileIndex].content = editor.value;
                files[currentFileIndex].modified = true;
                showToast('üíæ Auto-sauvegarde');
            }
        }, 30000);

        // Initialisation
        updateFileList();
        updatePreview();
        updateStats();

        // Avertir avant de quitter si modifications non sauvegard√©es
        window.addEventListener('beforeunload', (e) => {
            const hasUnsaved = files.some(f => f.modified);
            if (hasUnsaved) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    </script>
</body>
</html>
